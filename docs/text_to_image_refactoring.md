# æ–‡ç”Ÿå›¾åŠŸèƒ½é‡æ„è®¾è®¡æ–‡æ¡£

## 1. èƒŒæ™¯è¯´æ˜

å½“å‰çš„æ‰¹å¤„ç†è®¾è®¡å¯¹äº"æ–‡ç”Ÿå›¾"åŠŸèƒ½çš„åŒºåˆ†ä¸å¤Ÿæ˜ç¡®ï¼Œéœ€è¦é’ˆå¯¹"æ–‡ç”Ÿå•å›¾"å’Œ"æ–‡ç”Ÿç»„å›¾"ä¸¤ç§æ¨¡å¼è¿›è¡Œé‡æ„ï¼Œå¹¶æ¸…æ™°åˆ†ç¦»å•æ¬¡ä»»åŠ¡å’Œæ‰¹å¤„ç†ä»»åŠ¡ã€‚

## 2. é‡æ„ç›®æ ‡

1. ä¼˜åŒ–ç”¨æˆ·ç•Œé¢ï¼Œä½¿åŠŸèƒ½åŒºåˆ†æ›´åŠ æ˜ç¡®
2. å¢å¼ºæ‰¹å¤„ç†æ ¸å¿ƒåŠŸèƒ½ï¼Œæ”¯æŒä¸åŒç±»å‹çš„æ–‡ç”Ÿå›¾ä»»åŠ¡
3. æ”¹è¿›æ–‡ä»¶å¤„ç†å’Œå‘½åé€»è¾‘
4. å®ç°å¤šå±‚æ¬¡è¿›åº¦è·Ÿè¸ªç³»ç»Ÿ

## 3. é‡æ„ä»»åŠ¡åˆ—è¡¨

### 3.1 æ”¹è¿›æ–‡ç”Ÿå›¾UIç•Œé¢ç»“æ„

- åœ¨"æ–‡ç”Ÿå›¾"æ ‡ç­¾é¡µé¡¶éƒ¨æ·»åŠ æ˜æ˜¾çš„åˆ‡æ¢æŒ‰é’®ï¼ŒåŒºåˆ†"æ–‡ç”Ÿå•å›¾"å’Œ"æ–‡ç”Ÿç»„å›¾"ä¸¤ç§æ¨¡å¼
- ä¸ºåˆ‡æ¢æŒ‰é’®æ·»åŠ æ¸…æ™°çš„è¯´æ˜æ–‡å­—ï¼Œè§£é‡Šå…¶ä½œç”¨
- æ˜ç¡®åˆ†ç¦»å•æ¬¡ä»»åŠ¡å’Œæ‰¹å¤„ç†ä»»åŠ¡åŒºåŸŸï¼Œé¿å…æ··æ·†
- æ ¹æ®æ‰€é€‰æ¨¡å¼åŠ¨æ€è°ƒæ•´ç•Œé¢ç»„ä»¶å’Œæç¤ºä¿¡æ¯

### 3.2 å¢å¼ºæ‰¹å¤„ç†æ ¸å¿ƒåŠŸèƒ½

- æ‰©å±•`BatchTask`ç±»ï¼Œæ·»åŠ å¯¹"æ–‡ç”Ÿå•å›¾"å’Œ"æ–‡ç”Ÿç»„å›¾"æ¨¡å¼çš„æ”¯æŒ
- åœ¨ä»»åŠ¡é…ç½®ä¸­æ·»åŠ åºåˆ—å›¾åƒç”Ÿæˆç›¸å…³å‚æ•°ï¼š
  - `sequential_image_generation`å‚æ•°
  - `sequential_image_generation_options`å‚æ•°
- æ›´æ–°ä»»åŠ¡ç”Ÿæˆå™¨ï¼Œæ”¯æŒå¤„ç†å¤šç§æ ¼å¼çš„æç¤ºè¯æ–‡ä»¶(txt, csv, xlsx)
- å®ç°é’ˆå¯¹ä¸åŒæ¨¡å¼çš„ä»»åŠ¡è°ƒåº¦é€»è¾‘

### 3.3 ä¼˜åŒ–æ–‡ä»¶å¤„ç†åŠŸèƒ½

- æ”¹è¿›æç¤ºè¯è§£æå™¨ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼çš„æ­£ç¡®è§£æ
- ä¸º"æ–‡ç”Ÿç»„å›¾"æ¨¡å¼æ·»åŠ æç¤ºè¯æ ¼å¼éªŒè¯å’Œç¤ºä¾‹æç¤º
- å®ç°ç”Ÿæˆå›¾åƒçš„æ™ºèƒ½å‘½åç³»ç»Ÿï¼š
  - æ–‡ç”Ÿå•å›¾ï¼šæ ¹æ®æç¤ºè¯é¡ºåºç¼–å·
  - æ–‡ç”Ÿç»„å›¾ï¼šåŒæ—¶åæ˜ æç¤ºè¯é¡ºåºå’Œç»„å†…ç›¸å¯¹é¡ºåº

### 3.4 å®ç°å¤šå±‚æ¬¡è¿›åº¦è·Ÿè¸ªç³»ç»Ÿ

- è®¾è®¡åˆ†å±‚çº§çš„è¿›åº¦æ˜¾ç¤ºæœºåˆ¶ï¼š
  - æ™®é€šæ‰¹å¤„ç†ä»»åŠ¡ï¼šæ˜¾ç¤ºæ€»ä½“è¿›åº¦ï¼ˆå¦‚ï¼šå·²å®Œæˆ5/20å¼ ï¼Œ25%ï¼‰
  - ç»„å›¾ç”Ÿæˆä»»åŠ¡ï¼šæ˜¾ç¤ºå½“å‰ç»„å›¾çš„ç”Ÿæˆè¿›åº¦ï¼ˆå¦‚ï¼šå½“å‰ç»„å›¾2/4å¼ ï¼Œ50%ï¼‰
  - ç»„å›¾æ‰¹å¤„ç†ä»»åŠ¡ï¼šåŒæ—¶æ˜¾ç¤ºæ€»ä½“æ‰¹å¤„ç†è¿›åº¦å’Œå½“å‰ç»„å›¾è¿›åº¦
- å®ç°è¿›åº¦æ¡å’Œæ–‡å­—è¯´æ˜ç›¸ç»“åˆçš„æ˜¾ç¤ºæ–¹å¼
- æ·»åŠ å®æ—¶æ›´æ–°ç”Ÿæˆå›¾ç‰‡çš„åŠŸèƒ½

## 4. å®ç°ç»†èŠ‚

### 4.1 UIç»“æ„æ”¹è¿›

```python
# åœ¨æ–‡ç”Ÿå›¾æ ‡ç­¾é¡µé¡¶éƒ¨æ·»åŠ æ¨¡å¼åˆ‡æ¢æŒ‰é’®
with gr.Tab("ğŸ“ æ–‡ç”Ÿå›¾", id="text_to_image"):
    with gr.Row():
        gr.Markdown("### è¯·é€‰æ‹©æ–‡ç”Ÿå›¾æ¨¡å¼")
        generation_mode = gr.Radio(
            choices=[("æ–‡ç”Ÿå•å›¾", "single"), ("æ–‡ç”Ÿç»„å›¾", "series")],
            label="ç”Ÿæˆæ¨¡å¼",
            value="single",
            info="æ–‡ç”Ÿå•å›¾ï¼šç”Ÿæˆç‹¬ç«‹çš„å•å¼ å›¾ç‰‡ | æ–‡ç”Ÿç»„å›¾ï¼šç”Ÿæˆä¸€ç»„ç›¸å…³è”çš„å›¾ç‰‡åºåˆ—"
        )
    
    # æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„è¯´æ˜
    single_mode_info = gr.Markdown(
        "#### æ–‡ç”Ÿå•å›¾æ¨¡å¼\nå•å¼ å›¾ç‰‡ç”Ÿæˆï¼Œæ¯ä¸ªæç¤ºè¯å¯¹åº”ä¸€å¼ å›¾ç‰‡ã€‚",
        visible=True
    )
    series_mode_info = gr.Markdown(
        "#### æ–‡ç”Ÿç»„å›¾æ¨¡å¼\nç”Ÿæˆä¸€ç»„ç›¸å…³è”çš„å›¾ç‰‡åºåˆ—ï¼Œé€‚åˆåˆ¶ä½œåˆ†é•œã€å±•ç¤ºå˜åŒ–è¿‡ç¨‹ç­‰ã€‚",
        visible=False
    )
    
    # åç»­åˆ†åˆ«åˆ›å»ºå•æ¬¡ä»»åŠ¡å’Œæ‰¹å¤„ç†ä»»åŠ¡åŒºåŸŸ
```

### 4.2 æ‰¹å¤„ç†æ ¸å¿ƒåŠŸèƒ½æ‰©å±•

```python
@dataclass
class BatchTask:
    """æ‰¹å¤„ç†ä»»åŠ¡"""
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    task_type: TaskType = TaskType.TEXT_TO_IMAGE
    status: TaskStatus = TaskStatus.PENDING
    prompt: str = ""
    input_files: List[str] = field(default_factory=list)
    input_urls: List[str] = field(default_factory=list)
    output_dir: str = ""
    output_files: List[str] = field(default_factory=list)
    # æ–°å¢å­—æ®µ
    is_sequential: bool = False  # æ˜¯å¦ä¸ºç»„å›¾ç”Ÿæˆæ¨¡å¼
    max_images: int = 1  # ç»„å›¾æ¨¡å¼ä¸‹çš„å›¾ç‰‡æ•°é‡
    current_subtask: int = 0  # å½“å‰å¤„ç†çš„å­ä»»åŠ¡ç´¢å¼•
    total_subtasks: int = 1  # æ€»å­ä»»åŠ¡æ•°é‡
```

### 4.3 æ–‡ä»¶å¤„ç†åŠŸèƒ½ä¼˜åŒ–

```python
def parse_prompts_file(file_path: str, mode: str = "single") -> List[str]:
    """è§£ææç¤ºè¯æ–‡ä»¶
    
    Args:
        file_path: æ–‡ä»¶è·¯å¾„
        mode: ç”Ÿæˆæ¨¡å¼ï¼Œ'single'ä¸ºæ–‡ç”Ÿå•å›¾ï¼Œ'series'ä¸ºæ–‡ç”Ÿç»„å›¾
    
    Returns:
        æç¤ºè¯åˆ—è¡¨
    """
    ext = Path(file_path).suffix.lower()
    prompts = []
    
    if ext == '.txt':
        with open(file_path, 'r', encoding='utf-8') as f:
            prompts = [line.strip() for line in f if line.strip()]
    elif ext == '.csv':
        import csv
        with open(file_path, 'r', encoding='utf-8') as f:
            reader = csv.reader(f)
            prompts = [row[0] for row in reader if row and row[0].strip()]
    elif ext == '.xlsx':
        import pandas as pd
        df = pd.read_excel(file_path, header=None)
        prompts = [str(p).strip() for p in df[0].tolist() if str(p).strip()]
    
    # ç»„å›¾æ¨¡å¼ä¸‹éªŒè¯æç¤ºè¯æ ¼å¼
    if mode == "series":
        for i, prompt in enumerate(prompts):
            if "ç”Ÿæˆ" not in prompt and "ç³»åˆ—" not in prompt and "ç»„" not in prompt:
                logging.warning(f"ç»„å›¾æ¨¡å¼ä¸‹çš„æç¤ºè¯ #{i+1} å¯èƒ½æ ¼å¼ä¸æ­£ç¡®: {prompt}")
    
    return prompts
```

### 4.4 å¤šå±‚æ¬¡è¿›åº¦è·Ÿè¸ªç³»ç»Ÿ

```python
@dataclass
class ProgressData:
    """è¿›åº¦æ•°æ®"""
    total_tasks: int = 0
    completed_tasks: int = 0
    current_task_index: int = 0
    current_task_id: str = ""
    current_task_prompt: str = ""
    is_sequential: bool = False
    total_images_in_sequence: int = 0
    completed_images_in_sequence: int = 0
    status: str = "idle"
    
    @property
    def total_progress_percentage(self) -> float:
        """è®¡ç®—æ€»ä½“è¿›åº¦ç™¾åˆ†æ¯”"""
        return (self.completed_tasks / max(1, self.total_tasks)) * 100 if self.total_tasks > 0 else 0
    
    @property
    def sequence_progress_percentage(self) -> float:
        """è®¡ç®—å½“å‰åºåˆ—è¿›åº¦ç™¾åˆ†æ¯”"""
        return (self.completed_images_in_sequence / max(1, self.total_images_in_sequence)) * 100 if self.is_sequential else 0
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            "total_tasks": self.total_tasks,
            "completed_tasks": self.completed_tasks,
            "total_progress_percentage": self.total_progress_percentage,
            "current_task_index": self.current_task_index,
            "current_task_id": self.current_task_id,
            "current_task_prompt": self.current_task_prompt,
            "is_sequential": self.is_sequential,
            "total_images_in_sequence": self.total_images_in_sequence,
            "completed_images_in_sequence": self.completed_images_in_sequence,
            "sequence_progress_percentage": self.sequence_progress_percentage,
            "status": self.status
        }
```

## 5. ç”¨æˆ·ç•Œé¢ä¼˜åŒ–ç¤ºä¾‹

### 5.1 æ–‡ç”Ÿå•å›¾æ¨¡å¼

å•æ¬¡ä»»åŠ¡åŒºåŸŸï¼š
- æç¤ºè¯è¾“å…¥æ¡†
- å›¾åƒå°ºå¯¸é€‰æ‹©
- ç”ŸæˆæŒ‰é’®
- ç»“æœæ˜¾ç¤ºåŒºåŸŸ

æ‰¹å¤„ç†ä»»åŠ¡åŒºåŸŸï¼š
- æç¤ºè¯æ–‡ä»¶ä¸Šä¼ 
- æ‰¹é‡æç¤ºè¯è¾“å…¥
- è¾“å‡ºç›®å½•è®¾ç½®
- æ‰¹é‡ç”ŸæˆæŒ‰é’®
- è¿›åº¦æ˜¾ç¤º

### 5.2 æ–‡ç”Ÿç»„å›¾æ¨¡å¼

å•æ¬¡ä»»åŠ¡åŒºåŸŸï¼š
- æç¤ºè¯è¾“å…¥æ¡†ï¼ˆå¸¦æœ‰æ ¼å¼æç¤ºï¼‰
- å›¾åƒå°ºå¯¸é€‰æ‹©
- ç»„å›¾æ•°é‡è®¾ç½®
- ç”ŸæˆæŒ‰é’®
- ç»“æœæ˜¾ç¤ºåŒºåŸŸ

æ‰¹å¤„ç†ä»»åŠ¡åŒºåŸŸï¼š
- æç¤ºè¯æ–‡ä»¶ä¸Šä¼ ï¼ˆå¸¦æœ‰æ ¼å¼è¯´æ˜ï¼‰
- æ‰¹é‡æç¤ºè¯è¾“å…¥ï¼ˆå¸¦æœ‰æ ¼å¼æç¤ºï¼‰
- è¾“å‡ºç›®å½•è®¾ç½®
- æ‰¹é‡ç”ŸæˆæŒ‰é’®
- å¤šå±‚æ¬¡è¿›åº¦æ˜¾ç¤º

## 6. å®æ–½è®¡åˆ’

1. å…ˆä¿®æ”¹UIç•Œé¢ç»“æ„ï¼Œæ·»åŠ æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
2. æ›´æ–°æ‰¹å¤„ç†æ ¸å¿ƒåŠŸèƒ½ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼
3. æ”¹è¿›æ–‡ä»¶å¤„ç†å’Œå‘½åé€»è¾‘
4. å®ç°å¤šå±‚æ¬¡è¿›åº¦è·Ÿè¸ªç³»ç»Ÿ
5. è¿›è¡ŒåŠŸèƒ½æµ‹è¯•å’Œä¼˜åŒ–